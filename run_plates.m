%% RUN_PLATES.M
% 
%  Ilya Kolb
%  2019
%  Top-level file for analyzing GCaMP96uf plates. Set parameters below
%  This runs the plates using a parfor loop

%% RUNNING
% # 1. using noMachine (or Putty or ssh) run `.startInteractiveMatlab 1` in
% terminal on LSF
% # 2. When MATLAB instance starts, edit the parameters below and run
% # 3. Monitor job status on http://lsf1.int.janelia.org/cluster_status/
% 

%%
% set to 1 if Wavesurfer was used in run

if isunix % running on cluster
    cd /groups/genie/genie/ilya/code
    addpath('GECI_NAA_code_20191003')
    cd /groups/genie/genie/ilya/code/GECI_NAA_code_20191003
    addpath Neuronal_Assay_Analysis Neuronal_Assay_Analysis/compare_mutant Neuronal_Assay_Analysis/export_fig ilastik
    addpath WaveSurfer WaveSurfer/trenches
    GECI_imaging_dir = '/groups/genie/genie/GECIScreenData/GECI_Imaging_Data';
else
    GECI_imaging_dir = 'Z:\GECIScreenData\GECI_Imaging_Data';
end
% GECI_NAA_code_20191003 folder


clc

%       WSoptions.
%                 nRecsPerWell: num stim pulses (e.g. 4)
%                 stim_sync_channel : = 4 for Rig 1, =1 for Rig 2
%                 andor_sync_channel: = 3 for Rig 1, =2 for Rig 2
WS = 1;
WSoptions.nRecsPerWell = 4;
WSoptions.stim_sync_channel = 4;
WSoptions.andor_sync_channel = 3;

% set to 1 to recalculate segmentation in NAA_process_dir_ver4
reprocessFlag = 1; 

if ~WS
    warning('WS is 0: assuming this is an old experiment that used ephus!!')
end

plates = {fullfile(GECI_imaging_dir, '20191209_GCaMP96uf_raw/P1a-20191125_GCaMP96uf'),...
    fullfile(GECI_imaging_dir, '20191209_GCaMP96uf_raw/P2a-20191125_GCaMP96uf'),...
    fullfile(GECI_imaging_dir, '20191209_GCaMP96uf_raw/P3a-20191125_GCaMP96uf'),...
    fullfile(GECI_imaging_dir, '20191209_GCaMP96uf_raw/P4a-20191125_GCaMP96uf')};

%     fullfile(GECI_imaging_dir, '20191112_GCaMP96uf_analyzed/P25a-20191028_mngGECO'),...
%     fullfile(GECI_imaging_dir, '20191112_GCaMP96uf_analyzed/P26a-20191028_mngGECO'),...
%     fullfile(GECI_imaging_dir, '20191112_GCaMP96uf_analyzed/P27a-20191028_mngGECO'),...
%     fullfile(GECI_imaging_dir, '20191112_GCaMP96uf_analyzed/P28a-20191028_mngGECO')};

% plates = {
%     fullfile(GECI_imaging_dir,'20170717_GCaMP96uf_analyzed/P1a-20170703_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20170717_GCaMP96uf_analyzed/P2a-20170703_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20170717_GCaMP96uf_analyzed/P3a-20170703_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20170717_GCaMP96uf_analyzed/P4a-20170703_GCaMP96uf')
%     ...
%     fullfile(GECI_imaging_dir,'20170725_GCaMP96uf_NIRGECO96_analyzed/P1a-20170710_GCaMP96uf'),...% note: this one may have problems due to NIRGECOs in same directory!
%     fullfile(GECI_imaging_dir,'20170725_GCaMP96uf_NIRGECO96_analyzed/P2a-20170710_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20170725_GCaMP96uf_NIRGECO96_analyzed/P3a-20170710_GCaMP96uf'),...
%     ...
%     fullfile(GECI_imaging_dir,'20170801_GCaMP96uf_analyzed/P1a-20170717_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20170801_GCaMP96uf_analyzed/P2a-20170717_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20170801_GCaMP96uf_analyzed/P3a-20170717_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20170801_GCaMP96uf_analyzed/P4a-20170717_GCaMP96uf'),...
%     ...
%     fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P1a-20180423_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P2a-20180423_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P3a-20180423_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P4a-20180423_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P5a-20180423_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P7a-20180423_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P8a-20180423_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P9a-20180423_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P10a-20180423_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P11a-20180423_GCaMP96uf'),...
%     ...
%     fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P1a-20180430_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P2a-20180430_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P3a-20180430_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P4a-20180430_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P5a-20180430_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P6a-20180430_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P7a-20180430_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P8a-20180430_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P9a-20180430_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P10a-20180430_GCaMP96uf'),...
%     fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P11a-20180430_GCaMP96uf'),...
%     };
    % 20180515_GCaMP96uf_analyzed
    % 20180508_GCaMP96uf_analyzed
    % 20170801_GCaMP96uf_analyzed
    % 20170725_GCaMP96uf_NIRGECO96_analyzed
    % 20170717_GCaMP96uf_analyzed
    % 20170711_GCaMP96uf_analyzed
    

% makes sure plate directory is correct
for i = 1:length(plates)
    assert(isfolder(plates{i}), ['Plate directory ' plates{i} ' not found! Check the name']);
end

tic

% runs plates on cluster
parfor i = 1:length(plates)
	diary(fullfile(plates{i}, 'log.txt'))
    plate_script_ver4(plates{i},'0', WS, WSoptions, reprocessFlag);
	diary off
	% clc
end
toc

