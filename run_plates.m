%% RUN_PLATES.M
% 
%  Ilya Kolb
%  2019
%  Top-level file for analyzing GCaMP96uf plates. Set parameters below
%  This runs the plates using a parfor loop

%% RUNNING
% # 1. using noMachine (or Putty or ssh) run `.startInteractiveMatlab 1` in
% terminal on LSF
% # 2. When MATLAB instance starts, edit the parameters below and run
% # 3. Monitor job status on http://lsf1.int.janelia.org/cluster_status/
% 

%%

% Edit these absolute paths if running for the first time!
if isunix % if running on cluster
    
    addpath('GECI_NAA_code')
    cd /groups/genie/genie/ilya/code/GECI_NAA_code
    addpath Neuronal_Assay_Analysis Neuronal_Assay_Analysis/compare_mutant Neuronal_Assay_Analysis/export_fig ilastik
    addpath WaveSurfer WaveSurfer/trenches
    GECI_imaging_dir = '/groups/genie/genie/GECIScreenData/GECI_Imaging_Data';
else
    GECI_imaging_dir = 'Z:\GECIScreenData\GECI_Imaging_Data';
end

clc

% WS: set to 1 if Wavesurfer was used in run
% NOTE: all plates prior to 2019 (i.e. all plates in the plates_2018
% variable below) were run WITHOUT Wavesurfer, so set  WS = 0 if analyzing
% those

WS = 1;

%       WSoptions.
%                 nRecsPerWell: num stim pulses (e.g. 4)
%                 stim_sync_channel : = 4 for Rig 1, =1 for Rig 2
%                 andor_sync_channel: = 3 for Rig 1, =2 for Rig 2
WSoptions.nRecsPerWell =       4; % number of recordings (stimulations) per well
WSoptions.stim_sync_channel =  4; % channel order of the stim_sync channel
WSoptions.andor_sync_channel = 3; % channel order of the andor_sync channel

% set to 1 to recalculate segmentation in NAA_process_dir_ver4
reprocessFlag = 1; 

if ~WS
    warning('WS is 0: assuming this is an old experiment that used ephus!!')
end

% 20191209_GCaMP96uf_analyzed (Yan's round 5)
% 20191125_XCaMP_analyzed (rig 2)
% 20190910_GCaMP96uf_analyzed (rig 1)
% 20190904_GCaMP96uf_analyzed (XCaMP comparison, rig 1)
% 20190903_GCaMP96uf_analyzed 
% 20190827_GCaMP96uf_analyzed (rig 1)


plates_rerun = {
    fullfile(GECI_imaging_dir, '20191005_GCaMP96uf_analyzed/P9a-20190930_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20191005_GCaMP96uf_analyzed/P10a-20190930_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20191005_GCaMP96uf_analyzed/P11a-20190930_GCaMP96uf'),
    ...
    fullfile(GECI_imaging_dir, '20191022_GCaMP96uf_analyzed/P9a-20191007_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20191022_GCaMP96uf_analyzed/P10a-20191007_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20191022_GCaMP96uf_analyzed/P11a-20191007_GCaMP96uf')
    };

plates_newbatch = {
    fullfile(GECI_imaging_dir, '20191005_GCaMP96uf_analyzed/P9a-20190930_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20191005_GCaMP96uf_analyzed/P10a-20190930_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20191005_GCaMP96uf_analyzed/P11a-20190930_GCaMP96uf'),
    ...
    fullfile(GECI_imaging_dir, '20191022_GCaMP96uf_analyzed/P9a-20191007_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20191022_GCaMP96uf_analyzed/P10a-20191007_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20191022_GCaMP96uf_analyzed/P11a-20191007_GCaMP96uf'),
    ...
    fullfile(GECI_imaging_dir, '20191216_GCaMP96uf_analyzed/P13a-20191202_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20191216_GCaMP96uf_analyzed/P14a-20191202_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20191216_GCaMP96uf_analyzed/P15a-20191202_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20191216_GCaMP96uf_analyzed/P16a-20191202_GCaMP96uf'),
    ...
    fullfile(GECI_imaging_dir, '20191209_GCaMP96uf_analyzed/P1a-20191125_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20191209_GCaMP96uf_analyzed/P2a-20191125_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20191209_GCaMP96uf_analyzed/P3a-20191125_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20191209_GCaMP96uf_analyzed/P4a-20191125_GCaMP96uf'),
    ...
    fullfile(GECI_imaging_dir, '20190910_GCaMP96uf_analyzed/P1a-20190826_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190910_GCaMP96uf_analyzed/P2a-20190826_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190910_GCaMP96uf_analyzed/P3a-20190826_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190910_GCaMP96uf_analyzed/P4a-20190826_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190910_GCaMP96uf_analyzed/P5a-20190826_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190910_GCaMP96uf_analyzed/P6a-20190826_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190910_GCaMP96uf_analyzed/P7a-20190826_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190910_GCaMP96uf_analyzed/P8a-20190826_GCaMP96uf'),
    ...
    fullfile(GECI_imaging_dir, '20190904_GCaMP96uf_analyzed/P13a-20190819_GCaMP96uf'),
    ...
    fullfile(GECI_imaging_dir, '20190903_GCaMP96uf_analyzed/P1a-20190819_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190903_GCaMP96uf_analyzed/P2a-20190819_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190903_GCaMP96uf_analyzed/P3a-20190819_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190903_GCaMP96uf_analyzed/P4a-20190819_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190903_GCaMP96uf_analyzed/P5a-20190819_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190903_GCaMP96uf_analyzed/P6a-20190819_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190903_GCaMP96uf_analyzed/P7a-20190819_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190903_GCaMP96uf_analyzed/P8a-20190819_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190903_GCaMP96uf_analyzed/P9a-20190819_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190903_GCaMP96uf_analyzed/P10a-20190819_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190903_GCaMP96uf_analyzed/P11a-20190819_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190903_GCaMP96uf_analyzed/P12a-20190819_GCaMP96uf'),
    ...
    fullfile(GECI_imaging_dir, '20190827_GCaMP96uf_analyzed/P6a-20190812_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190827_GCaMP96uf_analyzed/P7a-20190812_GCaMP96uf'),
    fullfile(GECI_imaging_dir, '20190827_GCaMP96uf_analyzed/P8a-20190812_GCaMP96uf')
    };

% mng-GECO plates
%     fullfile(GECI_imaging_dir, '20191112_GCaMP96uf_analyzed/P25a-20191028_mngGECO'),...
%     fullfile(GECI_imaging_dir, '20191112_GCaMP96uf_analyzed/P26a-20191028_mngGECO'),...
%     fullfile(GECI_imaging_dir, '20191112_GCaMP96uf_analyzed/P27a-20191028_mngGECO'),...
%     fullfile(GECI_imaging_dir, '20191112_GCaMP96uf_analyzed/P28a-20191028_mngGECO')};

% old ephus-based plates
plates_2018 = {
    fullfile(GECI_imaging_dir,'20170711_GCaMP96uf_analyzed/P1a-20170626_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20170711_GCaMP96uf_analyzed/P2a-20170626_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20170711_GCaMP96uf_analyzed/P3a-20170626_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20170711_GCaMP96uf_analyzed/P4a-20170626_GCaMP96uf'),...
    ...
    fullfile(GECI_imaging_dir,'20170717_GCaMP96uf_analyzed/P1a-20170703_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20170717_GCaMP96uf_analyzed/P2a-20170703_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20170717_GCaMP96uf_analyzed/P3a-20170703_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20170717_GCaMP96uf_analyzed/P4a-20170703_GCaMP96uf'),...
    ...
    fullfile(GECI_imaging_dir,'20170725_GCaMP96uf_NIRGECO96_analyzed/P1a-20170710_GCaMP96uf'),...% note: this one may have problems due to NIRGECOs in same directory!
    fullfile(GECI_imaging_dir,'20170725_GCaMP96uf_NIRGECO96_analyzed/P2a-20170710_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20170725_GCaMP96uf_NIRGECO96_analyzed/P3a-20170710_GCaMP96uf'),...
    ...
    fullfile(GECI_imaging_dir,'20170801_GCaMP96uf_analyzed/P1a-20170717_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20170801_GCaMP96uf_analyzed/P2a-20170717_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20170801_GCaMP96uf_analyzed/P3a-20170717_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20170801_GCaMP96uf_analyzed/P4a-20170717_GCaMP96uf'),...
    ...
    fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P1a-20180423_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P2a-20180423_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P3a-20180423_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P4a-20180423_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P5a-20180423_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P7a-20180423_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P8a-20180423_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P9a-20180423_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P10a-20180423_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180508_GCaMP96uf_analyzed/P11a-20180423_GCaMP96uf'),...
    ...
    fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P1a-20180430_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P2a-20180430_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P3a-20180430_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P4a-20180430_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P5a-20180430_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P6a-20180430_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P7a-20180430_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P8a-20180430_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P9a-20180430_GCaMP96uf'),...
    fullfile(GECI_imaging_dir,'20180515_GCaMP96uf_analyzed/P10a-20180430_GCaMP96uf'),...
      ...
      fullfile(GECI_imaging_dir,'20180725_embryonic_GCaMP96uf_analyzed/P1a-20180709_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180725_embryonic_GCaMP96uf_analyzed/P2a-20180709_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180725_embryonic_GCaMP96uf_analyzed/P3a-20180709_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180725_embryonic_GCaMP96uf_analyzed/P4a-20180709_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180725_embryonic_GCaMP96uf_analyzed/P5a-20180709_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180725_embryonic_GCaMP96uf_analyzed/P6a-20180709_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180725_embryonic_GCaMP96uf_analyzed/P7a-20180709_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180725_embryonic_GCaMP96uf_analyzed/P8a-20180709_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180725_embryonic_GCaMP96uf_analyzed/P9a-20180709_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180725_embryonic_GCaMP96uf_analyzed/P10a-20180709_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180725_embryonic_GCaMP96uf_analyzed/P11a-20180709_GCaMP96uf'),...
      ...
      fullfile(GECI_imaging_dir,'20180820_GCaMP96uf_analyzed/P5a-20180806_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180820_GCaMP96uf_analyzed/P6a-20180806_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180820_GCaMP96uf_analyzed/P7a-20180806_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180820_GCaMP96uf_analyzed/P8a-20180806_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180820_GCaMP96uf_analyzed/P9a-20180806_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180820_GCaMP96uf_analyzed/P10a-20180806_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180820_GCaMP96uf_analyzed/P11a-20180806_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180820_GCaMP96uf_analyzed/P12a-20180806_GCaMP96uf'),...
      ...
      fullfile(GECI_imaging_dir,'20180828_GCaMP96uf_analyzed/P1a-20180813_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180828_GCaMP96uf_analyzed/P2a-20180813_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180828_GCaMP96uf_analyzed/P3a-20180813_GCaMP96uf'),...
      fullfile(GECI_imaging_dir,'20180828_GCaMP96uf_analyzed/P4a-20180813_GCaMP96uf')
    };

% fullfile(GECI_imaging_dir,'20200310_GCaMP96uf_raw/P7a-20200224_GCaMP96uf')

plates = plates_newbatch;

% makes sure plate directory is correct
for i = 1:length(plates)
    assert(isfolder(plates{i}), ['Plate directory ' plates{i} ' not found! Check the name']);
end

tic

% runs plates on cluster
parfor i = 1:length(plates)
    if isfile(fullfile(plates{i}, 'log.txt'))
        delete(fullfile(plates{i}, 'log.txt'))
    end
    diary(fullfile(plates{i}, 'log.txt'))
    plate_script_ver4(plates{i},'0', WS, WSoptions, reprocessFlag);
	diary off
	% clc
end
toc
